function xhttp(a){var b=Deferred();if(a.onload){b=b.next(a.onload)}if(a.onerror){b=b.error(a.onerror)}a.onload=function(c){b.call(c)};a.onerror=function(c){b.fail(c)};setTimeout(function(){GM_xmlhttpRequest(a)},0);return b}xhttp.get=function(a){return xhttp({method:"get",url:a})};xhttp.post=function(a,b){return xhttp({method:"post",url:a,data:b,headers:{"Content-Type":"application/x-www-form-urlencoded"}})};function http(c){var e=Deferred();var b=new XMLHttpRequest();b.open(c.method,c.url,true);if(c.headers){for(var a in c.headers){if(c.headers.hasOwnProperty(a)){b.setRequestHeader(a,c.headers[a])}}}b.onreadystatechange=function(){if(b.readyState==4){e.call(b)}};b.send(c.data||null);e.xhr=b;return e}http.get=function(a){return http({method:"get",url:a})};http.post=function(a,b){return http({method:"post",url:a,data:b,headers:{"Content-Type":"application/x-www-form-urlencoded"}})};http.jsonp=function(e,g){if(!g){g={}}var c=(function(){return this})();var f=Deferred();var i=g.callback;if(!i){do{i="callback"+String(Math.random()).slice(2)}while(typeof(c[i])!="undefined")}g.callback=i;e+=(e.indexOf("?")==-1)?"?":"&";for(var b in g){if(g.hasOwnProperty(b)){e=e+encodeURIComponent(b)+"="+encodeURIComponent(g[b])+"&"}}var a=document.createElement("script");a.type="text/javascript";a.charset="utf-8";a.src=e;document.body.appendChild(a);c[i]=function h(d){delete c[i];document.body.removeChild(a);f.call(d)};return f};function Deferred(){return(this instanceof Deferred)?this.init():new Deferred()}Deferred.ok=function(a){return a};Deferred.ng=function(a){throw a};Deferred.prototype={init:function(){this._next=null;this.callback={ok:Deferred.ok,ng:Deferred.ng};return this},next:function(a){return this._post("ok",a)},error:function(a){return this._post("ng",a)},call:function(a){return this._fire("ok",a)},fail:function(a){return this._fire("ng",a)},cancel:function(){(this.canceller||function(){})();return this.init()},_post:function(b,a){this._next=new Deferred();this._next.callback[b]=a;return this._next},_fire:function(a,c){var b="ok";try{c=this.callback[a].call(this,c)}catch(d){b="ng";c=d;if(Deferred.onerror){Deferred.onerror(d)}}if(c instanceof Deferred){c._next=this._next}else{if(this._next){this._next._fire(b,c)}}return this}};Deferred.next_default=function(a){var b=new Deferred();var c=setTimeout(function(){b.call()},0);b.canceller=function(){clearTimeout(c)};if(a){b.callback.ok=a}return b};Deferred.next_faster_way_readystatechange=((location.protocol=="http:")&&!window.opera&&/\bMSIE\b/.test(navigator.userAgent))&&function(a){var f=new Deferred();var c=new Date().getTime();if(c-arguments.callee._prev_timeout_called<150){var e=false;var b=document.createElement("script");b.type="text/javascript";b.src="javascript:";b.onreadystatechange=function(){if(!e){f.canceller();f.call()}};f.canceller=function(){if(!e){e=true;b.onreadystatechange=null;document.body.removeChild(b)}};document.body.appendChild(b)}else{arguments.callee._prev_timeout_called=c;var g=setTimeout(function(){f.call()},0);f.canceller=function(){clearTimeout(g)}}if(a){f.callback.ok=a}return f};Deferred.next_faster_way_Image=((typeof(Image)!="undefined")&&document.addEventListener)&&function(a){var e=new Deferred();var b=new Image();var c=function(){e.canceller();e.call()};b.addEventListener("load",c,false);b.addEventListener("error",c,false);e.canceller=function(){b.removeEventListener("load",c,false);b.removeEventListener("error",c,false)};b.src="data:,/ _ / X";if(a){e.callback.ok=a}return e};Deferred.next=Deferred.next_faster_way_readystatechange||Deferred.next_faster_way_Image||Deferred.next_default;Deferred.wait=function(e){var b=new Deferred(),a=new Date();var c=setTimeout(function(){b.call((new Date).getTime()-a.getTime())},e*1000);b.canceller=function(){clearTimeout(c)};return b};Deferred.call=function(b){var a=Array.prototype.slice.call(arguments,1);return Deferred.next(function(){return b.apply(this,a)})};Deferred.parallel=function(d){if(arguments.length>1){d=Array.prototype.slice.call(arguments)}var c=new Deferred(),a={},b=0;for(var e in d){if(d.hasOwnProperty(e)){(function(g,f){g.next(function(h){a[f]=h;if(--b<=0){if(d instanceof Array){a.length=d.length;a=Array.prototype.slice.call(a,0)}c.call(a)}}).error(function(h){c.fail(h)});b++})(d[e],e)}}if(!b){Deferred.next(function(){c.call()})}c.canceller=function(){for(var f in d){if(d.hasOwnProperty(f)){d[f].cancel()}}};return c};Deferred.earlier=function(d){var c=new Deferred(),a={},b=0;for(var e in d){if(d.hasOwnProperty(e)){(function(g,f){g.next(function(h){a[f]=h;if(d instanceof Array){a.length=d.length;a=Array.prototype.slice.call(a,0)}c.canceller();c.call(a)}).error(function(h){c.fail(h)});b++})(d[e],e)}}if(!b){Deferred.next(function(){c.call()})}c.canceller=function(){for(var f in d){if(d.hasOwnProperty(f)){d[f].cancel()}}};return c};Deferred.loop=function(e,a){var d={begin:e.begin||0,end:(typeof e.end=="number")?e.end:e-1,step:e.step||1,last:false,prev:null};var b,c=d.step;return Deferred.next(function(){function f(g){if(g<=d.end){if((g+c)>d.end){d.last=true;d.step=d.end-g+1}d.prev=b;b=a.call(this,g,d);if(b instanceof Deferred){return b.next(function(h){b=h;return Deferred.call(f,g+c)})}else{return Deferred.call(f,g+c)}}else{return b}}return(d.begin<=d.end)?Deferred.call(f,d.begin):null})};Deferred.repeat=function(e,d){var c=0,a={},b=null;return Deferred.next(function(){var f=(new Date()).getTime();divide:{do{if(c>=e){break divide}b=d(c++)}while((new Date()).getTime()-f<20);return Deferred.call(arguments.callee)}})};Deferred.register=function(b,a){this.prototype[b]=function(){var c=arguments;return this.next(function(){return a.apply(this,c)})}};Deferred.register("loop",Deferred.loop);Deferred.register("wait",Deferred.wait);Deferred.Arguments=function(a){this.args=Array.prototype.slice.call(a,0)};Deferred.connect=function(a,c){if(!c){c={}}var e=c.ok;var d=c.ng;var b=c.target;return function(){var h=new Deferred();h.next=function(j){return this._post("ok",function(){j.apply(this,(arguments[0] instanceof Deferred.Arguments)?arguments[0].args:arguments)})};var f=Array.prototype.slice.call(arguments,0);if(!(isFinite(e)&&e!==null)){e=f.length}var i=function(){h.call(new Deferred.Arguments(arguments))};f.splice(e,0,i);if(isFinite(d)&&d!==null){var g=function(){h.fail(arguments)};f.splice(d,0,g)}Deferred.next(function(){a.apply(b,f)});return h}};Deferred.retry=function(f,g,b){if(!b){b={}}var c=b.wait||0;var e=new Deferred();var a=function(){var d=g(f);d.next(function(h){e.call(h)}).error(function(h){if(--f<=0){e.fail(["retry failed",h])}else{setTimeout(a,c*1000)}})};setTimeout(a,0);return e};Deferred.define=function(d,c){if(!c){c=["parallel","wait","next","call","loop","repeat"]}if(!d){d=(function b(){return this})()}for(var a=0;a<c.length;a++){var e=c[a];d[e]=Deferred[e]}return Deferred};if(!NicoHTML5){var NicoHTML5={}}NicoHTML5.sec2MinSec=function(b){var a="000"+Math.floor(b/60);var c="00"+Math.floor(b%60);return a.substr(a.length-3,3)+":"+c.substr(c.length-2,2)};NicoHTML5.Player=function(){this.initialize.apply(this,arguments)};NicoHTML5.Player.prototype={initialize:function(a,d,b){this.video_id=a;this.target=d;this.options={overlaytype:"canvas",commentInterval:80,videoInfo:{duration:0,viewCount:0,commentCount:0,mylistCount:0,thumbnail:null}};if(b!=undefined){for(var c in b){this.options[c]=b[c]}}this.info={};this.logData=""},createPlayer:function(){var o=this;var q=512,p=384;var l=24;var t=document.createElement("div");t.className="nicohtml5_player";var s=document.createElement("div");s.className="videoplayer";s.style.zIndex=0;this.videoPlayer=new NicoHTML5.VideoPlayer(s,{width:q,height:p,onPlay:function(){o.onPlay()},onPause:function(){o.onPause()},onEnded:function(){o.onPause()},onSeek:function(){o.onSeek()},onFailed:function(u,v){alert(v)}});var b=this.videoPlayer.videoContainer;if(this.options.overlaytype=="canvas"){var h=document.createElement("canvas");h.className="commentoverlay";h.style.zIndex=1;this.commentOverlay=new NicoHTML5.CanvasCommentOverlay(h,q,p)}else{var h=document.createElement("div");h.className="commentoverlay";h.style.zIndex=1;this.commentOverlay=new NicoHTML5.DOMCommentOverlay(h,q,p,l/2)}b.appendChild(h);this.commentEngine=new NicoHTML5.CommentEngine(q,p,l,{calculateCommentSize:function(u){o.commentOverlay.calculateCommentSize(u)},showComments:function(u){o.commentOverlay.showComments(u)},setShowComment:function(u){o.commentOverlay.setShowComment(u)},removeShowComment:function(u){o.commentOverlay.removeShowComment(u)}});var j=document.createElement("div");j.className="commentlist";this.commentList=new NicoHTML5.CommentList(j,{});var c=document.createElement("form");c.className="commentbox";c.onsubmit=function(){alert("('A`)");return false};var i=document.createElement("input");i.type="text";i.className="commentbox_mail";var n=document.createElement("input");n.type="text";n.className="commentbox_comment";var r=document.createElement("input");r.value="コメント";r.type="submit";r.className="commentbox_submit";c.appendChild(i);c.appendChild(n);c.appendChild(r);var e=document.createElement("form");e.className="options";var k=document.createElement("label");var g=document.createElement("input");g.type="checkbox";g.className="options_autoscroll";g.checked=true;var a=document.createTextNode("再生に合わせてスクロールする");this.autoScrollCheck=g;k.appendChild(g);k.appendChild(a);e.appendChild(k);var d=document.createElement("div");d.className="infobox";this.infobox=d;var f=document.createElement("div");f.className="adsbar";var m=document.createElement("textarea");m.className="logbox";m.readonly=true;this.logbox=m;t.appendChild(s);t.appendChild(j);t.appendChild(c);t.appendChild(e);t.appendChild(d);t.appendChild(m);t.appendChild(f);this.updateInfo();this.target.appendChild(t)},updateInfo:function(){var b=this.options.videoInfo;var a=function(h,f){var g=document.createElement("p");g.className="infobox_line";var d=document.createElement("span");d.className="infobox_line_title";d.innerHTML=h;g.appendChild(d);var i=document.createElement("span");i.className="infobox_line_content";i.innerHTML=f;g.appendChild(i);return g};if(this.infobox){this.infobox.innerHTML="";this.infobox.appendChild(a("再生数",b.viewCount));this.infobox.appendChild(a("コメント数",b.commentCount));this.infobox.appendChild(a("マイリスト数",b.mylistCount))}},log:function(a){this.logData=this.logData+a+"\n";if(this.logbox){this.logbox.innerHTML=this.logData;this.logbox.scrollTop=this.logbox.scrollHeight}},getVideo:function(){var a=this;a.info={};return http.get("/api/getflv/"+a.video_id).next(function(d){if(d.status!=200){throw"response failed."}var f=a.info;var b=d.responseText.split("&");for(var c=0;c<b.length;c++){var e=b[c].split("=");f[e[0]]=decodeURIComponent(e[1])}if(f.url==undefined){throw"cannot get video url."}if(/http:\/\/[^/]+\/smile\?(v|m|s)=/.test(f.url)){if(RegExp.$1!="m"){throw"this video is not supported."}}else{throw"unknown video url"}})},getNGList:function(){var a=this;return http.get("/api/configurengclient?mode=get").next(function(d){if(d.status!=200){return}var b=d.responseXML;if(b.getElementsByTagName("response_ngclient")[0].attributes.status.value!="ok"){return}a.ngusers=[];a.ngwords=[];var e=b.getElementsByTagName("ngclient");for(var c=0;c<e.length;c++){var f={source:e[c].getElementsByTagName("source")[0].textContent,registered:e[c].getElementsByTagName("register_time")[0].textContent};if(e[c].getElementsByTagName("type")[0].textContent=="id"){a.ngusers.push(f)}else{a.ngwords.push(f)}}})},getComment:function(){var a=this;var b=200;if(this.options.videoInfo.duration){if(this.options.videoInfo.duration>=300){b=500}if(this.options.videoInfo.duration>=600){b=1000}}return http.jsonp("http://commentproxy.appspot.com/getcomment",{ms:a.info.ms,t:a.info.thread_id,res_from:b}).next(function(c){if(c.status=="ok"){a.info.ticket=c.thread.ticket;a.info.last_res=c.thread.last_res;a.comments=c.comments.sort(function(e,d){return e.vpos-d.vpos})}})},onPlay:function(){var a=this;if(this.commentUpdate==null){this.commentUpdate=setInterval(function(){a.main()},this.options.commentInterval)}},onPause:function(){clearInterval(this.commentUpdate);this.commentUpdate=null},onSeek:function(){var a=this.videoPlayer.video.currentTime;this.commentEngine.jump(a);if(this.commentUpdate==null){this.main()}},main:function(){var a=this.videoPlayer.video.currentTime;this.commentEngine.moveComments(a);if(this.autoScrollCheck.checked){var b=Math.floor(a*100);this.commentList.scrollToVpos(b)}},start:function(){var a=this;Deferred.next(function(){return a.getVideo()}).next(function(){a.log("getvideo() ok");a.createPlayer();a.log("createplayer() ok");a.videoPlayer.load(a.info.url);return a.getComment()}).next(function(){a.log("getComment() ok");a.commentList.setComments(a.comments);a.commentEngine.setComments(a.comments);a.options.videoInfo.commentCount=a.info.last_res;a.updateInfo();return a.getNGList()}).next(function(){a.log("getNGList() ok");if(a.ngwords){a.commentEngine.setNGWords(a.ngwords)}if(a.ngusers){a.commentEngine.setNGUsers(a.ngusers)}a.log("ready.")}).error(function(b){a.log("error : "+b);alert(b)})}};NicoHTML5.VideoPlayer=function(){this.initialize.apply(this,arguments)};NicoHTML5.VideoPlayer.prototype={initialize:function(c,a){this.target=c;this.options={width:512,height:384,onLoadStart:null,onFailed:null,onPlay:null,onSeek:null,onPause:null,onEnded:null};if(a!=undefined){for(var b in a){this.options[b]=a[b]}}this.playTimer=null;this.createPlayer()},createPlayer:function(){var j=this;var e=document.createElement("div");e.className="videoplayer_video_container";this.videoContainer=e;var i=document.createElement("video");i.className="videoplayer_video";i.width=this.options.width;i.height=this.options.height;i.autoplay=false;i.autobuffer=false;if(!!navigator.userAgent.match(/iPad/)){i.controls=true}else{i.controls=false}i.addEventListener("error",function(){j.onError()});i.addEventListener("progress",function(){j.onProgress()});i.addEventListener("loadedmetadata",function(){j.onLoadedMetaData()});i.addEventListener("loadeddata",function(){j.onLoadedData()});i.addEventListener("canplay",function(){j.onCanPlay()});i.addEventListener("play",function(){j.onPlay()});i.addEventListener("playing",function(){j.onPlaying()});i.addEventListener("seek",function(){j.onSeek()});i.addEventListener("pause",function(){j.onPause()});i.addEventListener("ended",function(){j.onEnded()});this.video=i;e.appendChild(i);var b=document.createElement("div");b.className="videoplayer_controls_container";var h=document.createElement("div");h.className="videoplayer_play_button";h.innerHTML="&nbsp;&nbsp;&nbsp;&#x25B6;&#x2590;";h.addEventListener("mousedown",function(){j.pressPlayButton()});var d=document.createElement("div");d.className="videoplayer_back_button";d.innerHTML="&#x2590;&#x25C0;&nbsp;";d.addEventListener("mousedown",function(){j.pressBackButton()});var g=document.createElement("div");this.seekbar=new NicoHTML5.Seekbar(g,function(k){j.onSeek(k)});var c=document.createElement("div");c.className="videoplayer_time";this.timeElm=c;var a=document.createElement("div");a.className="videoplayer_volumebar";var f=document.createElement("div");this.volumebar=new NicoHTML5.Seekbar(f,function(k){j.onVolumeChange(k)});this.volumebar.setDuration(1);this.volumebar.setBuffered(1);a.appendChild(f);b.appendChild(h);b.appendChild(d);b.appendChild(g);b.appendChild(c);b.appendChild(a);this.target.appendChild(e);this.target.appendChild(b)},pressPlayButton:function(){if(this.video.paused){this.play()}else{this.pause()}},pressBackButton:function(){if(this.video.currentTime>0){this.onSeek(0)}},play:function(){if(this.video.currentSrc==undefined||this.video.currentSrc==""){return}if(this.video.readyState<=1){return}this.video.play()},pause:function(){this.video.pause()},load:function(a){this.video.src=a;this.video.load();if(this.loadTimer){clearInterval(this.loadTimer);this.laodTimer=null}},onProgress:function(){},onLoadedMetaData:function(){this.seekbar.setDuration(this.video.duration);this.volumebar.setPosition(this.video.volume);this.onUpdate();var a=this;if(this.loadTimer==null){this.loadTimer=setInterval(function(){a.onLoadedData()},500)}},onLoadedData:function(){if(this.video.buffered.length>0){var a=this.video.buffered.end(0);this.seekbar.setBuffered(a)}},onCanPlay:function(){if(this.autoplay){this.play()}},onPlay:function(){},onUpdate:function(){this.timeElm.innerHTML=NicoHTML5.sec2MinSec(this.video.currentTime)+" / "+NicoHTML5.sec2MinSec(this.video.duration);this.seekbar.setPosition(this.video.currentTime,false)},onPlaying:function(){var a=this;if(this.playTimer==null){this.playTimer=setInterval(function(){a.onUpdate()},100)}if(this.options.onPlay){this.options.onPlay()}},onPause:function(){if(this.playTimer){clearInterval(this.playTimer)}this.playTimer=null;if(this.options.onPause){this.options.onPause()}},onEnded:function(){if(this.options.onEnded){this.options.onEnded()}},onSeek:function(a){this.video.currentTime=a;this.onUpdate();if(this.options.onSeek){this.options.onSeek(a)}},onVolumeChange:function(a){this.video.volume=a},onError:function(){var a="";switch(this.video.error.code){case MediaError.MEDIA_ERR_ABORTED:a="process was aborted";break;case MediaError.MEDIA_ERR_NETWORK:a="network error";break;case MediaError.MEDIA_ERR_DECODE:a="decode error";break;case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:a="source not supported";break;default:a="unknown error";break}if(this.options.onFailed){this.options.onFailed(this.video.error.code,a)}}};NicoHTML5.Seekbar=function(){this.initialize.apply(this,arguments)};NicoHTML5.Seekbar.prototype={initialize:function(a,b){this.target=a;this.callback=b;this.isDrag=false;this.createSeekbar();this.setEvent();this.setDuration(1);this.setBuffered(0);this.setPosition(0)},createSeekbar:function(){this.scaleElm=document.createElement("div");this.scaleElm.className="videoplayer_seekbar_scale";this.bufferedElm=document.createElement("div");this.bufferedElm.className="videoplayer_seekbar_buffered";this.unbufferedElm=document.createElement("div");this.unbufferedElm.className="videoplayer_seekbar_unbuffered";this.scaleElm.appendChild(this.bufferedElm);this.scaleElm.appendChild(this.unbufferedElm);this.tabElm=document.createElement("div");this.tabElm.className="videoplayer_seekbar_tab";this.target.className="videoplayer_seekbar";this.target.appendChild(this.scaleElm);this.target.appendChild(this.tabElm)},setEvent:function(){var a=this;this.scaleElm.addEventListener("mousedown",function(b){a.scaleMouseDown(b)},false);this.tabElm.addEventListener("mousedown",function(b){a.tabMouseDown(b)},false);document.addEventListener("mousemove",function(b){a.mouseMove(b)},false);document.addEventListener("mouseup",function(b){a.mouseUp(b)},false)},setPosition:function(c,b){if(this.isDrag&&!b){return}if(c<0){this.position=0}else{if(c>this.buffered){this.position=this.buffered}else{this.position=c}}var a=this.scaleElm.scrollWidth*(this.position/this.duration);this.tabElm.style.left=a+"px"},setBuffered:function(a){if(a<0){this.buffered=0}else{if(a>this.duration){this.buffered=this.duration}else{this.buffered=a}}var c=Math.round(this.buffered/this.duration*100);this.bufferedElm.style.width=c+"%";this.unbufferedElm.style.width=(100-c)+"%"},setDuration:function(a){if(a<0){return}this.duration=a;this.setBuffered(this.buffered);this.setPosition(this.position)},changeTabPosition:function(b){var c=0;var f=this.scaleElm;do{c+=f.offsetLeft||0;f=f.offsetParent}while(f);var a=window.scrollX+b-c;var d=a/(this.scaleElm.scrollWidth);this.setPosition(this.duration*d,true)},scaleMouseDown:function(a){var b=this.position;this.changeTabPosition(a.clientX);if(this.position!=b&&this.callback){this.callback(this.position)}},tabMouseDown:function(a){this.isDrag=true;this.beforePosition=this.position;a.stopPropagation()},mouseUp:function(a){if(!this.isDrag){return}this.isDrag=false;if(this.callback){this.callback(this.position)}},mouseMove:function(a){if(!this.isDrag){return}this.changeTabPosition(a.clientX)}};NicoHTML5.CommentList=function(){this.initialize.apply(this,arguments)};NicoHTML5.CommentList.prototype={initialize:function(a){this.target=a;this.createList()},createList:function(){var b=document.createElement("div");b.className="commentlist_head";var f=document.createElement("div");f.className="commentlist_head_time";f.innerHTML="再生時";var e=document.createElement("div");e.className="commentlist_head_comment";e.innerHTML="コメント";var a=document.createElement("div");a.className="commentlist_head_date";a.innerHTML="書込日時";var d=document.createElement("div");d.className="commentlist_head_no";d.innerHTML="コメ番";b.appendChild(f);b.appendChild(e);b.appendChild(a);b.appendChild(d);var c=document.createElement("ul");c.className="commentlist_list";this.list=c;this.target.appendChild(b);this.target.appendChild(c)},setComments:function(g){this.listIndex=[];for(var c=0;c<g.length;c++){var a=document.createElement("li");a.className="commentlist_comment";var f=document.createElement("div");f.className="commentlist_comment_time";f.innerHTML="<p>"+NicoHTML5.sec2MinSec(g[c].vpos/100)+"</p>";var e=document.createElement("div");e.className="commentlist_comment_comment";e.innerHTML="<p>"+g[c].content+"</p>";var b=document.createElement("div");b.className="commentlist_comment_date";b.innerHTML="<p>"+g[c].date+"</p>";var d=document.createElement("div");d.className="commentlist_comment_no";d.innerHTML="<p>"+g[c].no+"</p>";a.appendChild(f);a.appendChild(e);a.appendChild(b);a.appendChild(d);this.list.appendChild(a);this.listIndex.push({vpos:g[c].vpos,li:a})}},scrollToVpos:function(b){var c=0;for(var a=0;a<this.listIndex.length;a++){if(this.listIndex[a].vpos>b){c=this.listIndex[a].li.offsetTop;break}}if(c-this.list.offsetHeight<0){this.list.scrollTop+0}else{this.list.scrollTop=c-this.list.offsetHeight}}};NicoHTML5.CommentEngine=function(){this.initialize.apply(this,arguments)};NicoHTML5.CommentEngine.prototype={SPEED:500,STOP_SPEED:300,TYPE_NORMAL:0,TYPE_TOP:1,TYPE_BOTTOM:2,SIZE_NORMAL:0,SIZE_SMALL:1,SIZE_BIG:2,COLOR:["#FFFFFF","#FF0000","#FF8080","#FFCC00","#FFFF00","#00FF00","#00FFFF","#0000FF","#CC00FF","#CCCC99","#CC0033","#FF6600","#999900","#00CC66","#33FFFC","#6633CC","#000000"],initialize:function(c,a,e,d){this.screenWidth=c;this.screenHeight=a;this.maxShow=e;this.callbacks={calculateCommentSize:null,showComments:null,setShowComment:null,removeShowComment:null,};if(d!=undefined){for(var b in d){this.callbacks[b]=d[b]}}this.ngUsersRegExp=null;this.ngWordsRegExp=null;this.comments=null;this.showComments=[];this.commentPointer=0},createPattern:function(c){if(c==undefined||c.length<=0){return""}var b="("+c[0].source;for(var a=1;a<c.length;a++){b=b+"|"+c[a].source}b=b+")";return b},setNGUsers:function(b){var a=this.createPattern(b);if(a.length>0){this.ngUsersRegExp=new RegExp("^"+a+"$")}else{this.ngUsersRegExp=null}},setNGWords:function(b){var a=this.createPattern(b);if(a.length>0){this.ngWordsRegExp=new RegExp(a,"i")}else{this.ngWordsRegExp=null}},setComments:function(a){this.comments=a.sort(function(d,c){return d.vpos-c.vpos});this.commentPointer=0;this.showComments=[]},getCommentType:function(a){var b=this.TYPE_NORMAL;if(a){if(a.match(/\bue\b/i)){b=this.TYPE_TOP}else{if(a.match(/\bshita\b/i)){b=this.TYPE_BOTTOM}}}return b},getCommentFontSize:function(a){var b=this.SIZE_NORMAL;if(a){if(a&&a.match(/\bsmall\b/i)){b=this.SIZE_SMALL}else{if(a&&a.match(/\bbig\b/i)){b=this.SIZE_BIG}}}return b},getCommentColor:function(a){color=0;if(a){if(a.match(/\bred\b/i)){color=1}else{if(a.match(/\bpink\b/i)){color=2}else{if(a.match(/\borange\b/i)){color=3}else{if(a.match(/\byellow\b/i)){color=4}else{if(a.match(/\bgreen\b/i)){color=5}else{if(a.match(/\bcyan\b/i)){color=6}else{if(a.match(/\bblue\b/i)){color=7}else{if(a.match(/\bpurple\b/i)){color=8}else{if(a.match(/\b(niconicowhite|white2)\b/i)){color=9}else{if(a.match(/\b(truered|red2)\b/i)){color=10}else{if(a.match(/\b(passionorange|orange2)\b/i)){color=11}else{if(a.match(/\b(madyellow|yellow2)\b/i)){color=12}else{if(a.match(/\b(elementalgreen|green2)\b/i)){color=13}else{if(a.match(/\b(marinblue|blue2)\b/i)){color=14}else{if(a.match(/\b(nobleviolet|purple2)\b/i)){color=15}else{if(a.match(/\bblack\b/i)){color=16}}}}}}}}}}}}}}}}}return this.COLOR[color]},isNGComment:function(a){if(this.ngUsersRegExp&&a.user_id.match(this.ngUsersRegExp)){return true}if(this.ngWordsRegExp&&a.content.match(this.ngWordsRegExp)){return true}return false},removeShowComment:function(b){for(var a=0;a<this.showComments.length;a++){if(this.showComments[a]==b){if(this.callbacks.removeShowComment){this.callbacks.removeShowComment(b)}this.showComments.splice(a,1);return}}},removeAllShowComments:function(){for(var a=0;a<this.showComments.length;a++){if(this.callbacks.removeShowComment){this.callbacks.removeShowComment(this.showComments[a])}}this.showComments=[]},setShowComment:function(h,f){if(this.isNGComment(h)){return}var d=this.getCommentType(h.mail);var e=this.getCommentFontSize(h.mail);var b=this.getCommentColor(h.mail);var a=h.vpos;a+=(d==0?this.SPEED:this.STOP_SPEED);if(a<f){return}if(this.showComments.length>this.maxShow){return}var g={c:h,type:d,fontSize:e,color:b,pos:{x:0,y:0},size:{width:0,height:0},speed:0,isMine:false,};if(this.callbacks.calculateCommentSize){this.callbacks.calculateCommentSize(g)}this.showComments.push(g);switch(d){case this.TYPE_NORMAL:this.setPositionNormal(g,f);break;case this.TYPE_TOP:this.setPositionTop(g);break;case this.TYPE_BOTTOM:this.setPositionBottom(g);break}this.checkDanmaku(g);if(this.callbacks.setShowComment){this.callbacks.setShowComment(g)}},checkDanmaku:function(a){if(a.pos.y+a.size.height>this.screenHeight||a.pos.y<0){a.pos.y=Math.floor(Math.random*(this.screenHeight-a.size.height))}},getPositionAtVpos:function(d,a,c,b){return Math.floor((a-(b*(d-c)))-(a*0.2))},checkCollisionWidth:function(c,b,e,d){var f=this.getPositionAtVpos(e,d,c.c.vpos,c.speed);var a=this.getPositionAtVpos(e,d,b.c.vpos,b.speed);if(c.c.vpos<=b.c.vpos){if(f+c.size.width+10>a){return true}}else{if(a+b.size.width+10>f){return true}}return false},checkCollisionHeight:function(e,d){var g=e.pos.y;var h=e.pos.y+e.size.height;var c=d.pos.y;var f=d.pos.y+d.size.height;var b=(g>=c&&g<=f)||(h>=c&&h<=f);var a=(c>=g&&c<=h)||(f>=g&&f<=h);return(b||a)},setPositionNormal:function(g,f){g.speed=(this.screenWidth+g.size.width*2)/this.SPEED;g.pos.x=this.getPositionAtVpos(f,this.screenWidth,g.c.vpos,g.speed);g.pos.y=0;var e;do{var b=0;e=false;for(var d=0;d<this.showComments.length;d++){var a=this.showComments[d];if(g==a){continue}if(g.type!=a.type){continue}if(this.checkCollisionHeight(g,a)){if(this.checkCollisionWidth(g,a,f+this.SPEED,this.screenWidth)||this.checkCollisionWidth(g,a,f+(this.SPEED/2),this.screenWidth)||this.checkCollisionWidth(g,a,f,this.screnWidth)){if(b<a.size.height){b=a.size.height}e=true}}}if(e){g.pos.y+=b+1}}while(g.pos.y+g.size.height<this.screenHeight&&e)},setPositionTop:function(f){f.pos.x=(this.screenWidth-f.size.width)/2;f.pos.y=0;var e;do{var b=0;e=false;for(var d=0;d<this.showComments.length;d++){var a=this.showComments[d];if(f==a){continue}if(f.type!=a.type){continue}if(this.checkCollisionHeight(f,a)){if(b<a.size.height){b=a.size.height}e=true}}if(e){f.pos.y+=b+1}}while(f.pos.y+f.size.height<this.screenHeight&&e)},setPositionBottom:function(f){f.pos.x=(this.screenWidth-f.size.width)/2;f.pos.y=this.screenHeight-f.size.height;var e;do{var b=0;e=false;for(var d=0;d<this.showComments.length;d++){var a=this.showComments[d];if(f==a){continue}if(f.type!=a.type){continue}if(this.checkCollisionHeight(f,a)){if(b<a.size.height){b=a.size.height}e=true}}if(e){f.pos.y-=b+1}}while(f.pos.y>0&&e)},moveComments:function(e){var f=Math.floor(e*100);for(var b=0;b<this.showComments.length;b++){var h=this.showComments[b];if(h.type==this.TYPE_NORMAL){h.pos.x=this.getPositionAtVpos(f,this.screenWidth,h.c.vpos,h.speed)}var a=f-h.c.vpos;if((a>this.SPEED&&h.type==this.TYPE_NORMAL)||(a>this.STOP_SPEED&&h.type!=this.TYPE_NORMAL)){this.removeShowComment(h)}}var d=0;if(this.commentPointer<this.comments.length){var g=this.comments[this.commentPointer];while(g.vpos<=f){this.setShowComment(g,f);this.commentPointer++;if(this.commentPointer>=this.comments.length){break}g=this.comments[this.commentPointer];if(++d>8){break}}}if(this.callbacks.showComments){this.callbacks.showComments(this.showComments)}},jump:function(b){this.removeAllShowComments();var c=Math.floor(b*100);this.commentPointer=0;for(var a=0;a<this.comments.length;a++){if(this.comments[a].vpos<c-500){this.commentPointer++}else{break}}}};NicoHTML5.DOMCommentOverlay=function(){this.initialize.apply(this,arguments)};NicoHTML5.DOMCommentOverlay.prototype={DISABLE_CLIP:"rect(0px 0px 0px 0px)",initialize:function(b,c,a,d){this.container=b;this.setOverlaySize(c,a);this.createCommentLayer(d)},createCommentLayer:function(c){if(c==undefined){c=24}this.commentLayers=[];for(var b=0;b<c;b++){var a=document.createElement("div");a.className="commentoverlay_comment";a.style.display="block";a.style.clip="rect(0 0 0 0)";a._isUse=false;this.container.appendChild(a);this.commentLayers.push(a)}},setOverlaySize:function(e,a){this.overlayWidth=e;this.overlayHeight=a;this.container.style.width=e+"px";this.container.style.height=a+"px";this.fonts=[];this.lineHeights=[];var d=[16,20,12];for(var c=0;c<d.length;c++){var b=Math.floor(a/d[c]);this.fonts.push("bold "+b+"px 'ヒラギノ角ゴ Pro W3', 'Hiragino Kaku Gothic Pro', 'メイリオ', Meiryo,'ＭＳ Ｐゴ シック', sans-serif");this.lineHeights.push(b+4)}},clippingLayer:function(c){if(!c._isUse){if(c.style.clip!=this.DISABLE_CLIP){c.style.clip=this.DISABLE_CLIP}return}var f=0;if(c.offsetTop<0&&c.offsetTop+c.scrollHeight>0){f=c.scrollHeight-c.offsetTop}var a=c.scrollHeight;if(c.offsetTop<this.overlayHeight&&c.offsetTop+c.scrollHeight>this.overlayHeight){a=this.overlayHeight-c.offsetTop}if(c.offsetTop>=this.overlayHeight){a=0}var e=0;if(c.offsetLeft<0&&c.offsetLeft+c.scrollWidth>0){e=-c.offsetLeft}var b=c.scrollWidth;if(c.offsetLeft<this.overlayWidth&&c.offsetLeft+c.scrollWidth>this.overlayWidth){b=this.overlayWidth-c.offsetLeft}if(c.offsetLeft+c.scrollWidth<0||c.offsetLeft>=this.overlayWidth){a=0}var d="rect("+f+"px "+b+"px "+a+"px "+e+"px)";if(c.style.clip!=d){c.style.clip=d}},calculateCommentSize:function(d){var b=null;for(var a=0;a<this.commentLayers.length;a++){if(!this.commentLayers[a]._isUse){b=this.commentLayers[a];break}}if(b){b.style.color=d.color;b.style.font=this.fonts[d.fontSize];b.style.lineHeight=this.lineHeights[d.fontSize]+"px";b.innerHTML=d.c.content;b._isUse=true;d.size.width=b.scrollWidth;d.size.height=b.scrollHeight;d.layer=b}else{d.size.width=0;d.size.height=0;d.layer=null}},setShowComment:function(a){if(a.layer){a.layer.style.top=a.pos.y+"px";a.layer.style.left=a.pos.x+"px";this.clippingLayer(a.layer)}},removeShowComment:function(a){if(a.layer){a.layer._isUse=false;a.layer.innerHTML="";a.layer.style.top="-500px";a.layer.style.clip=this.DISABLE_CLIP}},showComments:function(b){for(var a=0;a<b.length;a++){var d=b[a];if(d.layer){d.layer.style.top=d.pos.y+"px";d.layer.style.left=d.pos.x+"px";this.clippingLayer(d.layer)}}},};NicoHTML5.CanvasCommentOverlay=function(){this.initialize.apply(this,arguments)};NicoHTML5.CanvasCommentOverlay.prototype={initialize:function(b,c,a){this.canvas=b;this.ctx=b.getContext("2d");this.setOverlaySize(c,a)},setOverlaySize:function(e,a){this.canvas.width=e;this.canvas.height=a;this.fonts=[];this.lineHeights=[];var d=[16,20,12];for(var c=0;c<d.length;c++){var b=Math.floor(a/d[c]);this.fonts.push("bold "+b+"px 'ヒラギノ角ゴ Pro W3', 'Hiragino Kaku Gothic Pro', 'メイリオ', Meiryo,'ＭＳ Ｐゴ シック', sans-serif");this.lineHeights.push(b+6)}},calculateCommentSize:function(b){this.ctx.font=this.fonts[b.fontSize];var a=this.ctx.measureText(b.c.content);b.size.width=a.width;b.size.height=this.lineHeights[b.fontSize]},showComments:function(b){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(var a=0;a<b.length;a++){var d=b[a];this.ctx.font=this.fonts[d.fontSize];this.ctx.textBaseline="top";this.ctx.textAlign="left";this.ctx.fillStyle=d.color;this.ctx.shadowColor="#000";this.ctx.shadowBlur=2;this.ctx.shadowOffsetY=0;this.ctx.fillText(d.c.content,d.pos.x,d.pos.y,this.canvas.width)}},setShowComment:function(a){},removeShowComment:function(a){}};(function(){if(navigator.userAgent.indexOf("AppleWebKit/")>-1){if(/watch\/([^/]+)$/.test(location.href)){var c=RegExp.$1;document.getElementById("old_flash_player_warning").innerHTML="";var a=document.getElementById("flvplayer_container");a.innerHTML="";var e=document.createElement("link");e.rel="stylesheet";e.href="http://labs.isidesystem.net/nicoh5/nicohtml5.css";e.type="text/css";document.getElementsByTagName("head")[0].appendChild(e);var d="canvas";if(NicoHTML5_OverlayType){d=NicoHTML5_OverlayType}var b=50;if(NicoHTML5_CommentInterval){b=NicoHTML5_CommentInterval}var f={};if(Video){f={duration:Video.length,viewCount:Video.viewCount,commentCount:0,mylistCount:Video.mylistCount,thumbnail:Video.thumbnail}}nicohtml5_player=new NicoHTML5.Player(c,a,{overlaytype:d,commentInterval:b,videoInfo:f});nicohtml5_player.start()}}else{alert("Sorry, Your browser is not supported.")}})();